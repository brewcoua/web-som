var W=["a[href]:not(:has(img))","a[href] img","button",'input:not([type="hidden"])',"select","textarea",'[tabindex]:not([tabindex="-1"])','[contenteditable="true"]',".btn",'[role="button"]','[role="link"]','[role="checkbox"]','[role="radio"]','[role="input"]','[role="menuitem"]','[role="menuitemcheckbox"]','[role="menuitemradio"]','[role="option"]','[role="switch"]','[role="tab"]','[role="treeitem"]','[role="gridcell"]','[role="search"]','[role="combobox"]','[role="listbox"]','[role="slider"]','[role="spinbutton"]'];class T{constructor(){this.elements=[],this.boxes=[]}colorFromLuminance(D){const[K,J,G]=D.map((N)=>N/255);return 0.299*K+0.587*J+0.114*G>0.5?"black":"white"}async isElementVisible(D){return new Promise((K)=>{const J=new IntersectionObserver(async(G)=>{const U=G[0];if(J.disconnect(),U.intersectionRatio<0.6){K(!1);return}const N=D.getBoundingClientRect();if(N.width<=1||N.height<=1){K(!1);return}if(N.width>=window.innerWidth*0.8||N.height>=window.innerHeight*0.8){K(!1);return}const j=await this.calculateVisibleAreaRatio(D,N);K(j>=0.6)});J.observe(D)})}drawElementOnCanvas(D,K,J,G,U="black"){const N=new Path2D,j=window.getComputedStyle(D),F=j.borderRadius?.split(" ").map((q)=>parseFloat(q)),X=j.clipPath,Q={top:Math.max(J.top-G.top,0),bottom:Math.min(J.bottom-G.top,G.height),left:Math.max(J.left-G.left,0),right:Math.min(J.right-G.left,G.width),width:Math.min(J.right-G.left,G.width)-Math.max(J.left-G.left,0),height:Math.min(J.bottom-G.top,G.height)-Math.max(J.top-G.top,0)};if(F){if(F.length===1)F[1]=F[0];if(F.length===2)F[2]=F[0];if(F.length===3)F[3]=F[1];N.moveTo(Q.left+F[0],Q.top),N.arcTo(Q.right,Q.top,Q.right,Q.bottom,F[1]),N.arcTo(Q.right,Q.bottom,Q.left,Q.bottom,F[2]),N.arcTo(Q.left,Q.bottom,Q.left,Q.top,F[3]),N.arcTo(Q.left,Q.top,Q.right,Q.top,F[0])}else N.rect(Q.left,Q.top,Q.width,Q.height);if(X&&X!=="none"){const q=new Path2D(X);N.addPath(q)}K.fillStyle=U,K.fill(N)}async calculateVisibleAreaRatio(D,K,J=!1){const G=document.createElement("canvas"),U=G.getContext("2d"),N=parseInt(window.getComputedStyle(D).zIndex||0,10);G.width=K.width,G.height=K.height,U.fillStyle="black",U.fillRect(0,0,G.width,G.height);const j={top:Math.max(0,K.top),left:Math.max(0,K.left),bottom:Math.min(window.innerHeight,K.bottom),right:Math.min(window.innerWidth,K.right)},F={width:j.right-j.left,height:j.bottom-j.top},X=()=>{const Y=U.getImageData(j.left-K.left,j.top-K.top,F.width,F.height).data;let $=0;for(let H=0;H<Y.length;H+=4)if(Y[H]>0)$++;return $};this.drawElementOnCanvas(D,U,K,K,"white");const Q=X(),q=await Promise.all(Array.from({length:Math.ceil(10)}).map(async(Y,$)=>{const H=document.elementsFromPoint(K.left+K.width*0.1*$,K.top+K.height*0.1*$),O=H.indexOf(D);return H.slice(0,O)})),L=Array.from(new Set(q.flat().filter((Y)=>Y!==D)));let w=[];for(let Y of L){if(parseInt(window.getComputedStyle(Y).zIndex||0,10)<N)continue;if(Y.contains(D)||D.contains(Y))continue;w.push(Y)}w=w.filter((Y)=>{for(let $ of w)if(Y!==$&&$.contains(Y))return!1;return!0}),await Promise.all(w.map(async(Y)=>{const $=Y.getBoundingClientRect();this.drawElementOnCanvas(Y,U,$,K,"black")}));const _=X();if(G.remove(),Q===0||_===0)return 0;return _/Q}async filterVisibleElements(D){return(await Promise.all(D.map(async(J)=>{if(J.offsetWidth===0&&J.offsetHeight===0)return null;const G=window.getComputedStyle(J);if(G.display==="none"||G.visibility==="hidden")return null;let U=J.parentElement,N=!0;while(U!==null){const X=window.getComputedStyle(U);if(X.display==="none"||X.visibility==="hidden"){N=!1;break}U=U.parentElement}if(!N)return null;const j=J.getBoundingClientRect();if(j.top>=window.innerHeight||j.bottom<=0||j.left>=window.innerWidth||j.right<=0)return null;if(!await this.isElementVisible(J))return null;return J}))).filter((J)=>J!==null)}async filterNestedElements(D){return(await Promise.all(D.map(async(J)=>{let G=J.parentElement;while(G!==null){if(D.includes(G))return null;G=G.parentElement}return J}))).filter((J)=>J!==null)}async loadElements(){const D=document.querySelectorAll(W.join(",")),K=document.querySelectorAll("*"),J=[];for(let N=0;N<K.length;N++)if(K[N].onclick!==null||window.getComputedStyle(K[N]).cursor==="pointer")J.push(K[N]);const G=Array.from(D).concat(J).filter((N,j,F)=>F.indexOf(N)===j),U=await this.filterVisibleElements(G);return await this.filterNestedElements(U)}async display(){this.clear();const D=await this.loadElements(),K=[],J=[];this.elements.push(...D);const G=()=>Math.floor(Math.random()*256);for(let U=0;U<D.length;U++){const j=D[U].getBoundingClientRect(),F=document.createElement("div");F.style.left=`${j.left}px`,F.style.top=`${j.top}px`,F.style.width=`${j.width}px`,F.style.height=`${j.height}px`,F.classList.add("SoM");const X=[G(),G(),G()];F.style.backgroundColor=`rgba(${X.join(",")}, 0.5)`,document.body.appendChild(F),J.push({top:j.top,bottom:j.bottom,left:j.left,right:j.right,width:j.width,height:j.height,color:X}),this.boxes.push(F)}for(let U=0;U<D.length;U++){const N=D[U],j=J[U],F=document.createElement("label");F.textContent=U,F.style.color=this.colorFromLuminance(j.color),F.style.backgroundColor=`rgba(${j.color.join(",")}, 0.7)`,this.boxes[U].appendChild(F);const X=F.getBoundingClientRect(),Q=10,q=[];for(let _=0;_<=Q;_++)q.push({top:j.top-X.height,left:j.left+j.width/Q*_-X.width/2}),q.push({top:j.bottom,left:j.left+j.width/Q*_-X.width/2}),q.push({top:j.top+j.height/Q*_-X.height/2,left:j.left-X.width}),q.push({top:j.top+j.height/Q*_-X.height/2,left:j.right});const L=q.map((_)=>{let Y=0;if(_.top<0||_.top+X.height>window.innerHeight||_.left<0||_.left+X.width>window.innerWidth)Y+=Infinity;else K.concat(J).forEach(($)=>{const H=Math.max(0,Math.min(_.left+X.width,$.left+$.width)-Math.max(_.left,$.left)),O=Math.max(0,Math.min(_.top+X.height,$.top+$.height)-Math.max(_.top,$.top));Y+=H*O});return Y}),w=q[L.indexOf(Math.min(...L))];F.style.top=`${w.top-j.top}px`,F.style.left=`${w.left-j.left}px`,K.push({top:w.top,left:w.left,width:X.width,height:X.height}),N.setAttribute("data-SoM",U)}}hide(){this.boxes.forEach((D)=>D.style.display="none")}show(){this.boxes.forEach((D)=>D.style.display="block")}clear(){this.elements.forEach((D)=>D.removeAttribute("data-SoM")),this.elements.length=0,this.boxes.forEach((D)=>D.remove()),this.boxes.length=0}resolve(D){if(D===null)return null;return this.elements[D]}}window.SoM=new T;
